/**
 * Revenue Share Calculator Service
 */

import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

/**
 * RevenueShare entities
 */
export enum RevenueShareType {
  VERIFIED_ENGAGEMENT = 'verified_engagement',
}

export interface RevenueShare {
  id: number;
  type: RevenueShareType;
  episodeId: number;
  userId: number;
  revenue: number;
  fraudRiskScore: number;
  payoutStatus: 'eligible' | 'ineligible';
  createdAt: Date;
}

/**
 * RevenueShareRepository
 */
@Injectable()
export class RevenueShareRepository {
  constructor(
    @InjectRepository(RevenueShare)
    private readonly revenueShareRepository: Repository<RevelShare>,
  ) {}

  // ... (methods for CRUD operations, querying, etc.)
}

/**
 * Revenue Share Calculator Service
 */
@Injectable()
export class RevShareCalculatorService {
  constructor(
    private readonly revenueShareRepository: RevenueShareRepository,
  ) {}

  /**
   * Calculate and save rev share for a given episode and user.
   * @param episodeId - The ID of the episode.
   * @param userId - The ID of the user.
   * @param revenue - The total revenue generated by the user during the episode.
   * @param fraudRiskScore - The fraud risk score associated with the user's actions.
   */
  async calculateAndSaveRevShare(
    episodeId: number,
    userId: number,
    revenue: number,
    fraudRiskScore: number,
  ): Promise<void> {
    // ... (logic for calculating payout eligibility and saving to the database)
  }
}

SQL:

CREATE TABLE IF NOT EXISTS revenue_shares (
  id SERIAL PRIMARY KEY,
  type VARCHAR(255) NOT NULL CHECK (type IN ('verified_engagement')),
  episode_id INT REFERENCES episodes(id),
  user_id INT REFERENCES users(id),
  revenue DECIMAL(10, 2) NOT NULL,
  fraud_risk_score DECIMAL(5, 4) NOT NULL,
  payout_status VARCHAR(16) CHECK (payout_status IN ('eligible', 'ineligible')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
);

Bash:

#!/bin/sh
set -euo pipefail

echo "Starting rev share calculation"
# ... (commands for calculating and saving revenue shares)
echo "Rev share calculation complete"

Terraform:

resource "aws_rds_table" "revshare" {
  name           = "revenue_shares"
  read_capacity  = 5
  write_capacity = 5

  schema = jsonencode([
    {
      Name        = "id"
      Type        = "INT"
      AutoIncrement = true
      PrimaryKey  = true
    },
    {
      Name        = "type"
      Type        = "VARCHAR(255)"
      Check       = "type IN ('verified_engagement')"
    },
    {
      Name        = "episode_id"
      Type        = "INT"
      References  = {
        name = "episodes"
        type = "foreignkey"
      }
    },
    {
      Name        = "user_id"
      Type        = "INT"
      References  = {
        name = "users"
        type = "foreignkey"
      }
    },
    {
      Name        = "revenue"
      Type        = "DECIMAL(10, 2)"
      NotNull     = true
    },
    {
      Name        = "fraud_risk_score"
      Type        = "DECIMAL(5, 4)"
      NotNull     = true
    },
    {
      Name        = "payout_status"
      Type        = "VARCHAR(16)"
      Check       = "payout_status IN ('eligible', 'ineligible')"
    },
    {
      Name        = "created_at"
      Type        = "TIMESTAMP WITH TIME ZONE"
      Default     = "CURRENT_TIMESTAMP"
    }
  ])
}
